<div class="bg-white rounded-lg shadow-md">
  <div class="p-4 border-b border-slate-200 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
    <h2 class="text-xl font-semibold">Invoice History</h2>
    <a routerLink="/invoices/new" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center w-full md:w-auto">
      <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Create New Invoice
    </a>
  </div>

  <!-- Invoice Table for Desktop -->
  <div class="overflow-x-auto hidden md:block">
    <table class="w-full text-sm text-left text-slate-500">
      <thead class="text-xs text-slate-700 uppercase bg-slate-50">
        <tr>
          <th class="px-6 py-3">Invoice ID</th>
          <th class="px-6 py-3">Date</th>
          <th class="px-6 py-3">Customer</th>
          <th class="px-6 py-3">Total</th>
          <th class="px-6 py-3">Payment Mode</th>
          <th class="px-6 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (invoice of invoiceService.invoices(); track invoice.id) {
          <tr class="bg-white border-b hover:bg-slate-50">
            <td class="px-6 py-4 font-medium text-slate-900">{{ invoice.id }}</td>
            <td class="px-6 py-4">{{ invoice.date | date:'short' }}</td>
            <td class="px-6 py-4">{{ invoice.customer.name }}</td>
            <td class="px-6 py-4 font-semibold">{{ invoice.total | currency:'INR' }}</td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-medium rounded-full"
                    [class]="{
                        'bg-blue-100 text-blue-800': invoice.paymentMode === 'UPI',
                        'bg-green-100 text-green-800': invoice.paymentMode === 'Cash',
                        'bg-purple-100 text-purple-800': invoice.paymentMode === 'Card'
                    }">
                    {{ invoice.paymentMode }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <button (click)="viewInvoiceDetails(invoice)" class="font-medium text-indigo-600 hover:text-indigo-800 mr-4">View</button>
              <a [routerLink]="['/invoices/edit', invoice.id]" class="font-medium text-amber-600 hover:text-amber-800">Edit</a>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="6" class="text-center p-8 text-slate-500">No invoices have been created yet.</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  
  <!-- Invoice Cards for Mobile -->
  <div class="md:hidden">
    @for (invoice of invoiceService.invoices(); track invoice.id) {
      <div class="p-4 border-b border-slate-200">
        <div class="flex gap-4">
          <div class="h-20 w-20 rounded-md bg-indigo-50 flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-slate-800">{{ invoice.id }}</h3>
            <p class="text-sm text-slate-500">{{ invoice.customer.name }}</p>
            <p class="text-sm text-slate-500">{{ invoice.date | date:'mediumDate' }}</p>
          </div>
          <div class="text-right flex flex-col items-end">
            <p class="text-lg font-semibold">{{ invoice.total | currency:'INR' }}</p>
            <span class="mt-1 px-2 py-1 text-xs font-medium rounded-full"
                  [class]="{
                      'bg-blue-100 text-blue-800': invoice.paymentMode === 'UPI',
                      'bg-green-100 text-green-800': invoice.paymentMode === 'Cash',
                      'bg-purple-100 text-purple-800': invoice.paymentMode === 'Card'
                  }">
                  {{ invoice.paymentMode }}
            </span>
          </div>
        </div>
        <div class="flex justify-end gap-4 mt-3">
          <button (click)="viewInvoiceDetails(invoice)" class="px-4 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-md font-medium text-indigo-600">View</button>
          <a [routerLink]="['/invoices/edit', invoice.id]" class="px-4 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-md font-medium text-amber-600">Edit</a>
        </div>
      </div>
    } @empty {
      <div class="text-center p-8 text-slate-500">No invoices have been created yet.</div>
    }
  </div>
</div>


<!-- Invoice Modal -->
@if (showModal() && selectedInvoice()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
      <div #invoiceDetailContent class="overflow-y-auto p-4 sm:p-6">
        <!-- Invoice Header -->
        <div class="flex justify-between items-start mb-6">
            <div>
              <h1 class="text-2xl font-bold">Advika collection</h1>
            </div>
            <div class="text-right">
              <p class="text-sm"><strong>Invoice No:</strong> {{ selectedInvoice()?.id }}</p>
              <p class="text-sm"><strong>Date:</strong> {{ selectedInvoice()?.date | date:'mediumDate' }}</p>
            </div>
        </div>
        <!-- Bill From / Bill To -->
        <div class="flex justify-between text-sm mb-6">
            <div>
                <p class="font-bold mb-1">Bill From:</p>
                <p>Advika collection</p>
                <p>71,C saket dham,indore</p>
                <p>8602689698</p>
            </div>
            <div class="text-right">
                <p class="font-bold mb-1">Bill To:</p>
                <p>{{ selectedInvoice()?.customer?.name }}</p>
                <p>{{ selectedInvoice()?.customer?.phone }}</p>
            </div>
        </div>
        <!-- Items Table -->
        <table class="w-full text-sm mb-4">
          <thead>
            <tr class="border-b-2 border-slate-300">
              <th class="text-left font-semibold py-2">Item</th>
              <th class="text-center font-semibold px-1 py-2">Qty</th>
              <th class="text-right font-semibold px-1 py-2">Price</th>
              <th class="text-right font-semibold px-1 py-2">Total</th>
            </tr>
          </thead>
          <tbody>
            @for (item of selectedInvoice()?.items || []; track item.id) {
              <tr class="border-b border-slate-200">
                <td class="py-2 pr-2">{{ item.name }}</td>
                <td class="text-center px-1 py-2">{{ item.cartQuantity }}</td>
                <td class="text-right px-1 py-2 whitespace-nowrap">{{ item.sellingPrice | currency:'INR' }}</td>
                <td class="text-right px-1 py-2 whitespace-nowrap">{{ (item.sellingPrice * item.cartQuantity) | currency:'INR' }}</td>
              </tr>
            }
          </tbody>
        </table>
        <!-- Totals Section -->
        <div class="flex justify-end">
            <div class="w-full max-w-xs text-sm">
                <div class="flex justify-between py-1"><span>Subtotal:</span> <span>{{ selectedInvoice()?.subtotal | currency:'INR' }}</span></div>
                <div class="flex justify-between py-1"><span>Discount:</span> <span class="text-green-600">- {{ selectedInvoice()?.totalDiscount | currency:'INR' }}</span></div>
                <div class="flex justify-between py-2 mt-1 font-bold text-lg border-t-2 border-slate-300"><span>Grand Total:</span> <span>{{ selectedInvoice()?.total | currency:'INR' }}</span></div>
                
                @if(dueInfo(); as due) {
                  <div class="flex justify-between py-1 border-t"><span>Amount Paid:</span> <span>{{ selectedInvoice()?.amountPaid | currency:'INR' }}</span></div>
                  <div class="flex justify-between py-1 font-semibold" [class]="due.isDue ? 'text-red-700' : 'text-black'">
                      <span>{{ due.label }}</span> 
                      <span>{{ due.value | currency:'INR' }}</span>
                  </div>
                }

                <div class="flex justify-between py-1"><span>Payment Mode:</span> <span>{{ selectedInvoice()?.paymentMode }}</span></div>
            </div>
        </div>
        <!-- Footer -->
        <div class="text-center mt-6 text-xs text-slate-500">
            <p>Thank you for your purchase!</p>
            <p>Visit us again.</p>
        </div>
      </div>
      <!-- Modal Actions -->
      <div class="p-4 bg-slate-50 flex flex-col sm:flex-row sm:justify-end gap-3 rounded-b-lg">
        <button type="button" (click)="closeModal()" class="w-full sm:w-auto px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">Close</button>
        <button (click)="prepareShare()" [disabled]="isPreparingShare()" class="w-full sm:w-auto px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 disabled:bg-green-300">
            @if (isPreparingShare()) {
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Preparing...</span>
            } @else {
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2 22l5.25-1.38c1.45.79 3.08 1.21 4.79 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zM12.04 20.12c-1.48 0-2.91-.4-4.19-1.15l-.3-.18-3.12.82.83-3.04-.2-.31c-.82-1.31-1.26-2.83-1.26-4.36 0-4.54 3.7-8.24 8.24-8.24 4.54 0 8.24 3.7 8.24 8.24S16.58 20.12 12.04 20.12zM17.29 14.48c-.28-.14-1.64-.81-1.9-0.9s-.45-.14-.64.14-.72.9-.88 1.08-.32.19-.59.05c-.28-.14-1.17-.43-2.23-1.38s-1.72-1.57-1.93-1.84c-.2-.28-.02-.43.12-.57.13-.13.28-.32.42-.49.14-.17.19-.28.28-.47s.05-.37-.02-.52c-.07-.14-.64-1.52-.88-2.09-.24-.57-.48-.48-.64-.48-.17 0-.36-.02-.54-.02s-.47.07-.72.36c-.25.28-.95.93-.95 2.26s.98 2.62 1.1 2.8c.14.17 1.9 2.91 4.6 4.07.64.28 1.15.45 1.54.58.55.18 1.05.16 1.45.1.44-.07 1.64-.67 1.87-1.3.24-.63.24-1.17.17-1.3s-.28-.24-.55-.38z"/>
                </svg>
                Share
            }
        </button>
        <button (click)="downloadInvoice()" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Download
        </button>
      </div>
    </div>
  </div>
}

<!-- Share Confirmation Modal -->
@if (shareableFile()) {
    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-lg font-semibold text-slate-800">Ready to Share</h3>
            <p class="text-slate-600 mt-2 mb-6">Your invoice image is ready. Click below to open the share menu.</p>
            <div class="flex justify-center gap-4">
                <button (click)="clearShare()" class="px-6 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">Cancel</button>
                <button (click)="executeShare()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Share Now</button>
            </div>
        </div>
    </div>
}